/*
 * summit_smb347.h
 *
 * Summit SMB347 Charger detection Driver
 *
 * Copyright (C) Amazon Technologies Inc. All rights reserved.
 * Donald Chan (hoiho@lab126.com)
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */

#define GPIO_SMB347_IRQ		2
#define SMB347_NAME		"smb347"

struct smb347_platform_data {
	const char *regulator_name;
};

#define SUMMIT_SMB347_ID			0xE

#define SUMMIT_SMB347_I2C_ADDRESS		0x5F
#define SUMMIT_SMB347_I2C_ADDRESS_SECONDARY	0x06

#define SMB347_CHARGE_CURRENT			0x0
#define SUMMIT_SMB347_INPUT_CURR_LIMIT		0x1
#define SUMMIT_SMB347_FUNCTIONS			0x2
#define SUMMIT_SMB347_FLOAT_VOLTAGE		0x3
#define SUMMIT_SMB347_CHARGE_CONTROL		0x4
#define SUMMIT_SMB347_STAT_TIMERS		0x5
#define SMB347_ENABLE_CONTROL			0x6
#define SUMMIT_SMB347_THERMAL_CONTROL		0x7
#define SUMMIT_SMB347_SYSOK_USB30		0x8
#define SMB347_OTHER_CONTROL_A			0x9
#define SUMMIT_SMB347_OTG_THERM_CONTROL	0xA
#define SUMMIT_SMB347_CELL_TEMP			0xB
#define SUMMIT_SMB347_FAULT_INTERRUPT		0xC
#define SUMMIT_SMB347_INTERRUPT_STAT		0xD
#define SUMMIT_SMB347_SLAVE_ADDR		0xE

#define SMB347_COMMAND_REG_A			0x30
#define SMB347_COMMAND_REG_B			0x31
#define SMB347_COMMAND_REG_C			0x33
#define SMB347_INTSTAT_REG_A			0x35
#define SMB347_INTSTAT_REG_B			0x36
#define SMB347_INTSTAT_REG_C			0x37
#define SMB347_INTSTAT_REG_D			0x38
#define SMB347_INTSTAT_REG_E			0x39
#define SMB347_INTSTAT_REG_F			0x3A
#define SMB347_STATUS_REG_A			0x3B
#define SMB347_STATUS_REG_B			0x3C
#define SMB347_STATUS_REG_C			0x3D
#define SMB347_STATUS_REG_D			0x3E
#define SMB347_STATUS_REG_E			0x3F

#define SMB_REGISTERS_CNT			(SMB347_STATUS_REG_E + 1)
#define SMB_REG_MAX_BURST			0x10

#define SUMMIT_SMB347_TLOW_THRESHOLD		37
#define SUMMIT_SMB347_THIGH_THRESHOLD		113
#define SUMMIT_SMB347_VHI_THRESHOLD		4350
#define SUMMIT_SMB347_VLO_THRESHOLD		2500

#define SMB347_OTH_CTL_CHG_CURR_COMP_SHIFT	6
#define SMB347_OTH_CTL_CHG_CURR_COMP_MASK	(0x03 << 6)
#define SMB347_OTH_CTL_CHG_CURR_COMP_250	0
#define SMB347_OTH_CTL_CHG_CURR_COMP_700	1
#define SMB347_OTH_CTL_CHG_CURR_COMP_900	2
#define SMB347_OTH_CTL_CHG_CURR_COMP_1200	3

#define SMB347_OTH_CTL_DTRTT_SHIFT		4
#define SMB347_OTH_CTL_DTRTT_MASK		(0x03 << 4)
#define SMB347_OTH_CTL_DTRTT_100C		0
#define SMB347_OTH_CTL_DTRTT_110C		1
#define SMB347_OTH_CTL_DTRTT_120C		2
#define SMB347_OTH_CTL_DTRTT_130C		3

#define SMB347_OTH_CTL_OTG_CL_USBIN_SHIFT	2
#define SMB347_OTH_CTL_OTG_CL_USBIN_MASK	(0x03 << 2)
#define SMB347_OTH_CTL_OTG_CL_USBIN_100	0
#define SMB347_OTH_CTL_OTG_CL_USBIN_200	1
#define SMB347_OTH_CTL_OTG_CL_USBIN_500	2
#define SMB347_OTH_CTL_OTG_CL_USBIN_750	3

#define SMB347_OTH_CTL_OTG_UVLO_THR_MASK	0x03
#define SMB347_OTH_CTL_OTG_UVLO_THR_2V7	0
#define SMB347_OTH_CTL_OTG_UVLO_THR_2V9	1
#define SMB347_OTH_CTL_OTG_UVLO_THR_3V1	2
#define SMB347_OTH_CTL_OTG_UVLO_THR_3V3	3

#define SMB347_CELL_HARD_LIM_COLD_ALRM_SHIFT	6
#define SMB347_CELL_HARD_LIM_COLD_ALRM_MASK	(0x03 << 6)
#define SMB347_CELL_HARD_LIM_COLD_ALRM_10	0
#define SMB347_CELL_HARD_LIM_COLD_ALRM_5	1
#define SMB347_CELL_HARD_LIM_COLD_ALRM_0	2
#define SMB347_CELL_HARD_LIM_COLD_ALRM_M5	3

#define SMB347_CELL_HARD_LIM_HOT_ALRM_SHIFT	4
#define SMB347_CELL_HARD_LIM_HOT_ALRM_MASK	(0x03 << 4)
#define SMB347_CELL_HARD_LIM_HOT_ALRM_50	0
#define SMB347_CELL_HARD_LIM_HOT_ALRM_55	1
#define SMB347_CELL_HARD_LIM_HOT_ALRM_60	2
#define SMB347_CELL_HARD_LIM_HOT_ALRM_65	3

#define SMB347_CELL_SOFT_LIM_COLD_ALRM_SHIFT	2
#define SMB347_CELL_SOFT_LIM_COLD_ALRM_MASK	(0x03 << 2)
#define SMB347_CELL_SOFT_LIM_COLD_ALRM_15	0
#define SMB347_CELL_SOFT_LIM_COLD_ALRM_10	1
#define SMB347_CELL_SOFT_LIM_COLD_ALRM_5	2
#define SMB347_CELL_SOFT_LIM_COLD_ALRM_0	3

#define SMB347_CELL_SOFT_LIM_HOT_ALRM_MASK	0x03
#define SMB347_CELL_SOFT_LIM_HOT_ALRM_40	0
#define SMB347_CELL_SOFT_LIM_HOT_ALRM_45	1
#define SMB347_CELL_SOFT_LIM_HOT_ALRM_50	2
#define SMB347_CELL_SOFT_LIM_HOT_ALRM_55	3

#define SMB347_APSD_COMPLETE			0x08
#define SMB347_APSD_RESULT(value)		((value) & 0x7)
#define SMB347_APSD_RESULT_NONE			(0)
#define SMB347_APSD_RESULT_CDP			(1)
#define SMB347_APSD_RESULT_DCP			(2)
#define SMB347_APSD_RESULT_OTHER		(3)
#define SMB347_APSD_RESULT_SDP			(4)
#define SMB347_APSD_RESULT_ACA			(5)
#define SMB347_APSD_RESULT_TBD_1		(6)
#define SMB347_APSD_RESULT_TBD_2		(7)

#define SMB347_STA_THERM_SOFT_LIM_REG_STATUS	0x80
#define SMB347_STA_THERM_REG_STATUS		0x40
#define SMB347_STA_ACTUAL_FLOAT_VOLT_MASK	0x3F

#define SMB347_STB_USB_SUSPEND_MODE		0x80
#define SMB347_STB_FAST_nPRE_CHARGING		0x20
#define SMB347_STB_FC_CURRENT_MASK		0x07
#define SMB347_STB_PC_CURRENT_MASK		0x18
#define SMB347_STB_PC_CURRENT_SHIFT		3

#define SMB347_STC_CHARGING_ENABLED		(0x01 << 0)
#define SMB347_STC_CHARGING_STATUS(value)	(((value) >> 1) & 0x3)
#define SMB347_STC_CHARGER_IN_HOLDOFF		(0x01 << 3)
#define SMB347_STC_VABAT_LESS_THAN2_1V		(0x01 << 4)
#define SMB347_STC_FULL_CHARGE_CYCLE		(0x01 << 5)
#define SMB347_STC_CHARGER_ERROR		(0x01 << 6)
#define SMB347_STC_CHARGER_ERR_ASSERTS_IRQ	(0x01 << 7)

#define SMB347_CHARGING_STATUS_NOT_CHARGING	(0)
#define SMB347_CHARGING_STATUS_PRE_CHARGING	(1)
#define SMB347_CHARGING_STATUS_FAST_CHARGING	(2)
#define SMB347_CHARGING_STATUS_TAPER_CHARGING	(3)
#define SMB347_CHARGING_STATUS_UNKNOWN		(4)

#define CHARGE_CURR_1800			(0x04 << 5)
#define CHARGE_CURR_1500			(0x03 << 5)
#define CHARGE_CURR_1200			(0x02 << 5)
#define CHARGE_CURR_900				(0x01 << 5)
#define CHARGE_CURR_0				(0x04 << 5)
#define CHARGE_CURR_MASK			(0x07 << 5)

#define PRECHARGE_CURR_100			(0x00 << 3)
#define PRECHARGE_CURR_150			(0x01 << 3)
#define PRECHARGE_CURR_200			(0x02 << 3)
#define PRECHARGE_CURR_250			(0x03 << 3)
#define PRECHARGE_CURR_MASK			(0x03 << 3)

#define TERM_CURR_37_5				0x00
#define TERM_CURR_50				0x01
#define TERM_CURR_100				0x02
#define TERM_CURR_150				0x03
#define TERM_CURR_200				0x04
#define TERM_CURR_250				0x05
#define TERM_CURR_500				0x06
#define TERM_CURR_600				0x07
#define TERM_CURR_MASK				0x07

#define USBIN_LIMIT_2500			0x09
#define USBIN_LIMIT_2200			0x08
#define USBIN_LIMIT_2000			0x07
#define USBIN_LIMIT_1800			0x06
#define USBIN_LIMIT_1500			0x05
#define USBIN_LIMIT_1200			0x04
#define USBIN_LIMIT_900				0x03
#define USBIN_LIMIT_700				0x02
#define USBIN_LIMIT_500				0x01
#define USBIN_LIMIT_300				0x00

#define DCIN_LIMIT_2500				(0x09 << 4)
#define DCIN_LIMIT_2200				(0x08 << 4)
#define DCIN_LIMIT_2000				(0x07 << 4)
#define DCIN_LIMIT_1800				(0x06 << 4)
#define DCIN_LIMIT_1500				(0x05 << 4)
#define DCIN_LIMIT_1200				(0x04 << 4)
#define DCIN_LIMIT_900				(0x03 << 4)
#define DCIN_LIMIT_700				(0x02 << 4)
#define DCIN_LIMIT_500				(0x01 << 4)
#define DCIN_LIMIT_300				(0x00 << 4)

#define SMB347_FN_AICL				(0x01 << 4)

#define SMB347_CHRG_CTL_NC_CHRGR_DET		(0x01 << 1)
#define SMB347_CHRG_CTL_FLEX_CHARGE		(0x01 << 2)
#define SMB347_CHRG_CTL_ARCHG_n50_100		(0x01 << 3)
#define SMB347_CHRG_CTL_BATT_MIS_DET_MASK	(0x03 << 4)
#define SMB347_CHRG_CTL_BATT_MIS_DET_SHIFT	4
#define SMB347_CHRG_CTL_BATT_MIS_DET_DISA	0x00
#define SMB347_CHRG_CTL_BATT_MIS_DET_BDM3S	0x01
#define SMB347_CHRG_CTL_BATT_MIS_DET_BDM	0x02
#define SMB347_CHRG_CTL_BATT_MIS_DET_THIO	0x03
#define SMB347_CHRG_CTL_CURR_TERM_END_CYCLE	(0x01 << 6)
#define SMB347_CHRG_CTL_AUTO_RECHARGE_ENABLE	(0x01 << 7)

#define SMB347_ENABLE_CTL_LED_BLINK		(0x01 << 7)
#define SMB347_ENABLE_CTL_I2C_0CMD_MASK	(0x03 << 5)
#define SMB347_ENABLE_CTL_I2C_0CMD_CH_DISA	(0x00 << 5)
#define SMB347_ENABLE_CTL_I2C_0CMD_CH_ENA	(0x01 << 5)
#define SMB347_ENABLE_CTL_I2C_0CMD_PINCTL_AH	(0x02 << 5)
#define SMB347_ENABLE_CTL_I2C_0CMD_PINCTL_AL	(0x03 << 5)
#define SMB347_ENABLE_CTL_USB_HC_PIN_nREG_CTL	(0x01 << 4)
#define SMB347_ENABLE_CTL_USB_HC_PIN_DUALSTATE	(0x01 << 3)
#define SMB347_ENABLE_CTL_CHARGER_ERR_IRQ_ENA	(0x01 << 2)
#define SMB347_ENABLE_CTL_APSD_DONE_IRQ_ENA	(0x01 << 1)
#define SMB347_ENABLE_CTL_DCIN_PREBIAS_ENA	(0x01 << 0)

#define SMB347_FAULT_IRQ_INTERNAL_OVR_TEMP	0x01
#define SMB347_FAULT_IRQ_AICL_COMPLETE		0x02
#define SMB347_FAULT_IRQ_INPUT_UNDERVOLTAGE	0x04
#define SMB347_FAULT_IRQ_INPUT_OVERVOLTAGE	0x08
#define SMB347_FAULT_IRQ_OTG_OVERCURRENT	0x10
#define SMB347_FAULT_IRQ_OTG_BATTERY_FAIL_UVLO	0x20
#define SMB347_FAULT_IRQ_TEMP_OUT_SOFT_LIMITS	0x40
#define SMB347_FAULT_IRQ_TEMP_OUT_HARD_LIMITS	0x80

#define SMB347_STAT_IRQ_LOW_BATT		0x01
#define SMB347_STAT_IRQ_MISS_BATT		0x02
#define SMB347_STAT_IRQ_INOK			0x04
#define SMB347_STAT_IRQ_FAST_CHARGING		0x08
#define SMB347_STAT_IRQ_TERM_OR_TAPER_CHARGING	0x10
#define SMB347_STAT_IRQ_BATT_OVERVOLTAGE	0x20
#define SMB347_STAT_IRQ_OTG_PLUG_UNPLUG	0x40
#define SMB347_STAT_IRQ_CHARGE_TIMEOUT		0x80

#define SMB347_CMDA_NV_CONF_WR_ENABLE		(0x01 << 7)
#define SMB347_CMDA_FC_ENABLE			(0x01 << 6)
#define SMB347_CMDA_THERM_OVERRIDE		(0x01 << 5)
#define SMB347_CMDA_OTG_ENABLE			(0x01 << 4)
#define SMB347_CMDA_BAT2SYS_CTL			(0x01 << 3)
#define SMB347_CMDA_USBIN_SUSPEND		(0x01 << 2)
#define SMB347_CMDA_CHARGING_ENABLE		(0x01 << 1)
#define SMB347_CMDA_STAT_OUT_nENABLE		(0x01 << 0)

#define SMB347_CMDB_HC_MODE			(0x01 << 0)
#define SMB347_CMDB_USB5_MODE			(0x01 << 1)
#define SMB347_CMDB_SUSPEND_DC_IN		(0x01 << 2)
#define SMB347_CMDB_RESET_SMB			(0x01 << 7)
#define SMB347_CMDB_MODE_MASK			0x03

#define SMB347_USB1_5_HC_MODE(value)		(((value) >> 5) & 0x3)

#define SMB347_HC_MODE				(0)
#define SMB347_USB1_MODE			(1)
#define SMB347_USB5_MODE			(2)

#define SMB347_STAT_POLARITY_AH			0x80
#define SMB347_STAT_OUT_MODE			0x40
#define SMB347_STAT_OUT_DISA			0x20
#define SMB347_STAT_NCC_HC			0x10

#define SMB347_TIMERS_CHARGE_COMPLETE_TO_MASK		(0x03 << 2)
#define SMB347_TIMERS_CHARGE_COMPLETE_TO_SHIFT		2
#define SMB347_TIMERS_CHARGE_COMPLETE_TO_382		(0 << 2)
#define SMB347_TIMERS_CHARGE_COMPLETE_TO_764		(1 << 2)
#define SMB347_TIMERS_CHARGE_COMPLETE_TO_1527		(2 << 2)
#define SMB347_TIMERS_CHARGE_COMPLETE_TO_DISA		(3 << 2)

#define SMB347_TIMERS_PRECHARGE_COMPLETE_TO_MASK	0x03
#define SMB347_TIMERS_PRECHARGE_COMPLETE_TO_SHIFT	0
#define SMB347_TIMERS_PRECHARGE_COMPLETE_TO_48		0
#define SMB347_TIMERS_PRECHARGE_COMPLETE_TO_95		1
#define SMB347_TIMERS_PRECHARGE_COMPLETE_TO_191	2
#define SMB347_TIMERS_PRECHARGE_COMPLETE_TO_DISA	3

#define ST_E_USBIN_IN_USE			0x80
#define ST_E_INPUT_MODE_MASK			0x60
#define ST_E_AICL_COMPLETE			0x10
#define ST_E_AICL_RESULT			0x0F

#define ST_E_INPUT_MODE_HC			(0x00 << 5)
#define ST_E_INPUT_MODE_USB1			(0x01 << 5)
#define ST_E_INPUT_MODE_USB5			(0x02 << 5)
#define ST_E_INPUT_MODE_NA			(0x03 << 5)

#define SMB347_IS_AICL_DONE(value)		((value) & (1 << 4))

#define SMB347_AICL_RESULT(value)		((value) & 0xf)

#define SMB347_INTSTX_STA			0x01
#define SMB347_INTSTX_IRQ			0x02
#define SMB347_INTSTX_FLMASK			0x03
#define SMB347_INTSTX_IRQ_RISE		(SMB347_INTSTX_IRQ | SMB347_INTSTX_STA)
#define SMB347_INTSTX_IRQ_FALL			SMB347_INTSTX_IRQ

#define SMB347_INTSTA				0x35
#define SMB347_INTSTA_HOT_HARD_IRQ		0x80
#define SMB347_INTSTA_HOT_HARD_STA		0x40
#define SMB347_INTSTA_COLD_HARD_IRQ		0x20
#define SMB347_INTSTA_COLD_HARD_STA		0x10
#define SMB347_INTSTA_HOT_SOFT_IRQ		0x08
#define SMB347_INTSTA_HOT_SOFT_STA		0x04
#define SMB347_INTSTA_COLD_SOFT_IRQ		0x02
#define SMB347_INTSTA_COLD_SOFT_STA		0x01

#define SMB347_INTSTB				0x36
#define SMB347_INTSTB_OVR_VOL_IRQ		0x80
#define SMB347_INTSTB_OVR_VOL_STA		0x40
#define SMB347_INTSTB_OVR_VOL_SHIFT		6
#define SMB347_INTSTB_BAT_MIS_IRQ		0x20
#define SMB347_INTSTB_BAT_MIS_STA		0x10
#define SMB347_INTSTB_BAT_MIS_SHIFT		4
#define SMB347_INTSTB_BAT_LOW_IRQ		0x08
#define SMB347_INTSTB_BAT_LOW_STA		0x04
#define SMB347_INTSTB_BAT_LOW_SHIFT		2
#define SMB347_INTSTB_PTF_CHG_IRQ		0x02
#define SMB347_INTSTB_PTF_CHG_STA		0x01
#define SMB347_INTSTB_PTF_CHG_SHIFT		0

#define SMB347_INTSTC				0x37
#define SMB347_INTSTC_INT_TRM_IRQ		0x80
#define SMB347_INTSTC_INT_TRM_STA		0x40
#define SMB347_INTSTC_INT_TRM_SHIFT		6
#define SMB347_INTSTC_RCH_THR_IRQ		0x20
#define SMB347_INTSTC_RCH_THR_STA		0x10
#define SMB347_INTSTC_RCH_THR_SHIFT		4
#define SMB347_INTSTC_TPR_CHA_IRQ		0x08
#define SMB347_INTSTC_TPR_CHA_STA		0x04
#define SMB347_INTSTC_TPR_CHA_SHIFT		2
#define SMB347_INTSTC_TER_CUR_IRQ		0x02
#define SMB347_INTSTC_TER_CUR_STA		0x01
#define SMB347_INTSTC_TER_CUR_SHIFT		0

#define SMB347_INTSTD				0x38
#define SMB347_INTSTD_APSD_COMPLETE_IRQ	0x80
#define SMB347_INTSTD_APSD_COMPLETE_STA	0x40
#define SMB347_INTSTD_APSD_COMPLETE_SHIFT	6
#define SMB347_INTSTD_AICL_COMPLETE_IRQ	0x20
#define SMB347_INTSTD_AICL_COMPLETE_STA	0x10
#define SMB347_INTSTD_AICL_COMPLETE_SHIFT	4
#define SMB347_INTSTD_CHG_COMPLETE_TO_IRQ	0x08
#define SMB347_INTSTD_CHG_COMPLETE_TO_STA	0x04
#define SMB347_INTSTD_CHG_COMPLETE_TO_SHIFT	2
#define SMB347_INTSTD_PRECHG_COMPLETE_TO_IRQ	0x02
#define SMB347_INTSTD_PRECHG_COMPLETE_TO_STA	0x01
#define SMB347_INTSTD_PRECHG_COMPLETE_TO_SHIFT	0

#define SMB347_INTSTE				0x39

#define SMB347_INTSTF				0x3A
#define SMB347_INTSTF_POK_IRQ			0x02
#define SMB347_INTSTF_POK_STA			0x01
#define SMB347_INTSTF_POK_SHIFT			0

#define RISE_IRQ(mreg, mirq) \
	(((priv->reg_cache[mreg] >> mreg ## _ ## mirq ## _SHIFT) & \
	SMB347_INTSTX_FLMASK) == SMB347_INTSTX_IRQ_RISE)

#define FALL_IRQ(mreg, mirq) \
	(((priv->reg_cache[mreg] >> mreg ## _ ## mirq ## _SHIFT) & \
	SMB347_INTSTX_FLMASK) == SMB347_INTSTX_IRQ_FALL)
